{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'upload/style.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

<h1>File System</h1>
<hr>
<form action="user_settings" method="post">
    {% csrf_token %}
    <div class="file-upload" style="">File system</div>
        {{ form.path.as_hidden}}
    <div class="file-upload" id="jstree"></div>
    <hr>
</form>

<script type="text/javascript">

    //loop through tree and
    $("#jstree").bind('ready.jstree', function(event, data) {
      var $tree = $(this);
      $($tree.jstree().get_json($tree, {
          flat: true
        }))
        .each(function(index, value) {
          var node = $("#jstree").jstree().get_node(this.id);
          //if node is file, then change icon to file
          //if (node.original.type == "file") node.icon == "//jstree.com/tree.png";
          if (node.original.type == "file") console.log(node.data-jstree);
          //var lvl = node.parents.length;
          //var idx = index;
          //console.log('this node = ' + JSON.stringify(node));
        });
    });

    $('#jstree').jstree().redraw();

    //make base url read only
    $("#id_base_folder").prop("readonly", true);
    $("#id_base_folder").attr("size", 100);

    //set base folder input value
    $("#id_base_folder").val("{{base_folder}}");

    //set checkbox for show files value
    //$("#id_show_files").val("{{show_files}}");

    var rawdata   = "{{ json_file_tree|escapejs }}"
    var data      = rawdata.replace(/'/g, '"');
    var dataObj   = JSON.parse(data);

    //mark checkbox
    if ("{{show_files}}" == 'True'){
      $("#id_show_files").prop( "checked", true );
    }

    //build tree based on structure from createtree
    $('#jstree').jstree({ 'core' : {
    'data' : JSON.parse(data)
    } });

    //select folder from file tree
    $('#jstree').on("changed.jstree", function (e, data) {
       //set selected path
       selected = data.node.original.fullPath;
       console.log('selected = ' + selected);
       //show add button when folder is chosen
       document.getElementById('id_base_folder').value = selected;
    });

 function readURL(input) {
  if (input.files && input.files[0]) {

    var reader = new FileReader();

    reader.onload = function(e) {
      $('.image-upload-wrap').hide();

      $('.file-upload-image').attr('src', e.target.result);
      $('.file-upload-content').show();

      $('.image-title').html(input.files[0].name);
    };

    reader.readAsDataURL(input.files[0]);
    enableButton()

  } else {
    removeUpload();
  }
}
</script>


